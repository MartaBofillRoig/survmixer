---
title: "survmixer: Sample size and effect size calculations for mixture survival  distributions"
# author: "MBofill"
date: "`r Sys.Date()`" 
output: 
  html_document:
    code_folding: hide
vignette: >
  %\VignetteIndexEntry{Computations}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
# html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# setwd("C:/Users/mbofi/Dropbox/Marta-Lupe/COLLABORATIONS/YUSHENCollaboration/RCode/Simulations-Mar2020")
```


## Preamble 

Required packages:
```{r, warning=FALSE, message=FALSE}
library(knitr) # purl function  
library(pracma)
```

## Introduction

Survival mixture distributions are a type of survival distribution in which it is assumed that there are  a proportion of subjects  who had experienced an event that will behave differently from those subjects wo not experienced the event.
<!-- a proportion of subjects who will not experience the event.  -->
In our model, these ‘responders’ and ‘non-responders’ subjects are modeled separately  using a parametric survival distribution. 

## Assumptions

  - Let $T_r^{(i)}$ and $T_{nr}^{(i)}$ the time to event for responders and non-responders in the group $i$, respectively.
  - Suppose that $T_r^{(i)}$ and $T_{nr}^{(i)}$ follow a weibull distribution with scale parameters $\lambda_{r}^{(i)}$ and $\lambda_{nr}^{(i)}$, respectively, and equal shape parameter  $\beta^{(i)}$, that is,  $T_r^{(i)} \sim Weibull(\lambda_{r}^{(i)}, \beta^{(i)})$ and $T_{nr}^{(i)}\sim Weibull(\lambda_{nr}^{(i)}, \beta^{(i)})$. 

## Preliminary functions


The function `survw_f` computes the Weibull survival function. 
```{r survexp}
survw_f <- function(t,lambda,bet){
  return(exp(-(t/lambda)^bet))
} 
```

The function `rmstw_f` computes the restricted mean survival times (RMST) according to the Weibull survival function. 
```{r}
rmstw_f <- function(lambda,bet,tau,low=0){ 
  r <- integrate(survw_f, lower = low, upper = tau, lambda, bet)$value
  return(r)
} 
```


The function `survmixture_f` computes the survival distribution as a mixture of  of responders and non-responders. The responders and non-responders distributions are assumed to be Weibull distributions.
```{r survmixt}
survmixture_f <- function(t,lambda_r, lambda_nr, bet=1, p){
  s <- survw_f(t,lambda_r,bet)*p + survw_f(t,lambda_nr,bet)*(1-p)
  return(s)
}
```

The function `survw_derivf` computes the derivative of the survival distribution  `survw_f`.
```{r}
survw_derivf <- function(t,lambda,bet=1){
  return(-bet*(t/lambda)^bet*exp(-(t/lambda)^bet)/t)
} 
```

The functions `meanw_f` and `medianw_f` calculate the mean and median for Weibull distributions, respectively.
```{r}
medianw_f <- function(lambda,bet){
  median = lambda*(log(2)^(1/bet))
  return(median)
}
```


```{r}
meanw_f <- function(lambda,bet){
  mean = lambda*gamma(1+1/bet)
  return(mean)
}
```

##  Variance computation

The following three functions are used to calculate the variance of th difference of two RMSTs. `survw_integratef` is used for the integrations; `inside_var` calculates the expression inside the integral; finally, `var_f` computes the variance.

```{r}
survw_integratef <- function(t,tau, lambda,bet){
 int <- integrate(survw_f,lower=t, upper=tau,lambda,bet)$value
 return(int) 
}
```


```{r}
inside_var <- function(t,lambda_r,lambda_nr,tau,bet,lambda_cens,p){
  
  num = p*sapply(t,survw_integratef,lambda=lambda_r,bet=bet,tau=tau)+(1-p)*sapply(t,survw_integratef,lambda=lambda_nr,bet=bet,tau=tau)
  den = survmixture_f(t,lambda_r, lambda_nr, bet, p)
  dervS = p*survw_derivf(t,lambda_r,bet) + (1-p)*survw_derivf(t,lambda_nr,bet)

  inside_integral <- (num/den)^2*(1/survw_f(t,lambda_cens,bet=1))*dervS

  return(-inside_integral)
}
```

```{r}
var_f <- function(lambda_r,lambda_nr,tau,bet,lambda_cens,p){
  integrate(inside_var,lower=0,upper=tau,lambda_r=lambda_r, lambda_nr= lambda_nr,tau=tau,bet=bet,lambda_cens=lambda_cens,p=p)$value
}
```


## Effect size and Sample size calculation

The function `survw_effectsize` calculates the effect size according to the distributional parameters of the responders and non-responders.
```{r} 

survw_effectsize <- function(lambda0_r,lambda0_nr,delta_p,p0,beta0,beta1,lambda1_r,lambda1_nr,tau, 
                             Delta_r=NULL, Delta_0=NULL, Delta_nr=NULL, anticipated_effects=FALSE){ 

  if(anticipated_effects == TRUE){
    os_effect = (p0 + delta_p)*Delta_r + (1-p0-delta_p)*Delta_nr + delta_p*Delta_0  
  }
  if(anticipated_effects == FALSE){
    p1 = delta_p +  p0
    Delta_0 = rmstw_f(lambda=lambda0_r,bet=beta0,tau=tau) - rmstw_f(lambda=lambda0_nr,bet=beta0,tau=tau)
    
    Delta_r = rmstw_f(lambda=lambda1_r,bet=beta1,tau=tau) - rmstw_f(lambda=lambda0_r,bet=beta0,tau=tau) 
    Delta_nr = rmstw_f(lambda=lambda1_nr,bet=beta1,tau=tau) - rmstw_f(lambda=lambda0_nr,bet=beta0,tau=tau)  
    
    k_1 = p1*rmstw_f(lambda=lambda1_r,bet=beta1,tau=tau) + (1-p1)*rmstw_f(lambda=lambda1_nr,bet=beta1,tau=tau)
    k_0 = p0*rmstw_f(lambda=lambda0_r,bet=beta0,tau=tau) + (1-p0)*rmstw_f(lambda=lambda0_nr,bet=beta0,tau=tau)
    
    os_effect = (p0 + delta_p)*Delta_r + (1-p0-delta_p)*Delta_nr + delta_p*Delta_0  
  }  
  
  
 return(os_effect) 
}
```



The function `survw_samplesize` calculates the sample size according to the distributional parameters of the responders and non-responders.
```{r}
survw_samplesize <- function(lambda0_r,lambda0_nr,delta_p,p0,beta0,beta1,lambda1_r,lambda1_nr,lambda_cens,tau,alpha=0.025,beta=0.2){ 

  z_alpha <- qnorm(1-alpha,0,1)  
  z_beta <-  qnorm(1-beta,0,1)
  p1 = delta_p +  p0
  
  os_effect = survw_effectsize(lambda0_r,lambda0_nr,delta_p,p0,beta0,beta1,lambda1_r,lambda1_nr,tau)
  
  var0 <- var_f(lambda_r=lambda0_r,lambda_nr=lambda0_nr,tau=tau,bet=beta0,lambda_cens=lambda_cens,p=p0)
  var1 <- var_f(lambda_r=lambda1_r,lambda_nr=lambda1_nr,tau=tau,bet=beta1,lambda_cens=lambda_cens,p=p1)
  ss = ((z_alpha+z_beta)/(os_effect))^2*(var0 + var1)/0.5
  
 return(ss) 
}

```



<!-- # Save R code -->
<!-- # ```{r} -->
<!-- # # require(knitr) # purl function -->
<!-- # # purl("Functions_Vignette.Rmd", output = "Functions.R", documentation = 2) -->
<!-- # ``` -->

